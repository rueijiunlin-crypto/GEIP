{% extends "base.html" %}

{% block title %}
    {% if news %}編輯最新消息{% else %}新增最新消息{% endif %} - GEIP管理後台
{% endblock %}

{% block page_title %}
    {% if news %}編輯最新消息{% else %}新增最新消息{% endif %}
{% endblock %}

{% block page_actions %}
<a href="{{ url_for('news_list') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> 返回列表
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-white">
                    <i class="bi bi-{{ 'pencil-square' if news else 'plus-circle' }}"></i>
                    {% if news %}編輯最新消息{% else %}新增最新消息{% endif %}
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" id="newsForm">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- 標題 -->
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    標題 <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       value="{{ title }}" required maxlength="200"
                                       placeholder="輸入最新消息標題...">
                                <div class="form-text">
                                    <span id="titleCount">0</span>/200 字元
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- 日期 -->
                            <div class="mb-3">
                                <label for="date" class="form-label">
                                    日期 <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="date" name="date" 
                                       value="{{ date }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 內容 -->
                    <div class="mb-3">
                        <label for="content" class="form-label">內容</label>
                        <textarea class="form-control" id="content" name="content" rows="6" 
                                  maxlength="5000" placeholder="輸入最新消息內容...">{{ content }}</textarea>
                        <div class="form-text">
                            <span id="contentCount">0</span>/5000 字元
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <!-- 連結 -->
                            <div class="mb-3">
                                <label for="link" class="form-label">連結</label>
                                <input type="url" class="form-control" id="link" name="link" 
                                       value="{{ link }}" placeholder="https://example.com">
                                <div class="form-text">可選，用於連結到詳細頁面或外部資源</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- 狀態 -->
                            <div class="mb-3">
                                <label for="status" class="form-label">狀態</label>
                                <select class="form-select" id="status" name="status">
                                    {% for status_option in status_options %}
                                    <option value="{{ status_option }}" 
                                            {{ 'selected' if status == status_option }}>
                                        {{ '已發布' if status_option == 'published' else '草稿' if status_option == 'draft' else '已封存' }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <span class="text-{{ 'success' if status == 'published' else 'warning' if status == 'draft' else 'secondary' }}">
                                        {{ '已發布' if status == 'published' else '草稿' if status == 'draft' else '已封存' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 預覽區域 -->
                    <div class="mb-3">
                        <label class="form-label">預覽</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="previewTitle" class="fw-bold mb-2"></div>
                            <div id="previewDate" class="text-muted small mb-2"></div>
                            <div id="previewContent"></div>
                            <div id="previewLink" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- 按鈕 -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{{ url_for('news_list') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                        </div>
                        <div>
                            {% if news %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 更新最新消息
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> 新增最新消息
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 字元計數
function updateCharCount(elementId, countElementId, maxLength) {
    const element = document.getElementById(elementId);
    const countElement = document.getElementById(countElementId);
    
    if (element && countElement) {
        const currentLength = element.value.length;
        countElement.textContent = currentLength;
        
        // 顏色提示
        if (currentLength > maxLength * 0.9) {
            countElement.className = 'text-danger';
        } else if (currentLength > maxLength * 0.7) {
            countElement.className = 'text-warning';
        } else {
            countElement.className = 'text-muted';
        }
    }
}

// 即時預覽
function updatePreview() {
    const title = document.getElementById('title').value || '標題預覽';
    const date = document.getElementById('date').value || '日期預覽';
    const content = document.getElementById('content').value || '內容預覽...';
    const link = document.getElementById('link').value;
    const status = document.getElementById('status').value;
    
    // 更新預覽標題
    document.getElementById('previewTitle').textContent = title;
    
    // 更新預覽日期
    if (date && date !== '日期預覽') {
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('previewDate').textContent = formattedDate;
    } else {
        document.getElementById('previewDate').textContent = '日期預覽';
    }
    
    // 更新預覽內容
    document.getElementById('previewContent').textContent = content;
    
    // 更新預覽連結
    if (link) {
        document.getElementById('previewLink').innerHTML = 
            `<a href="${link}" target="_blank" class="text-primary">
                <i class="bi bi-link-45deg"></i> ${link}
            </a>`;
    } else {
        document.getElementById('previewLink').innerHTML = '';
    }
    
    // 更新狀態提示
    const statusText = document.querySelector('#status + .form-text span');
    if (statusText) {
        const statusLabels = {
            'published': '已發布',
            'draft': '草稿',
            'archived': '已封存'
        };
        const statusColors = {
            'published': 'success',
            'draft': 'warning',
            'archived': 'secondary'
        };
        statusText.textContent = statusLabels[status] || status;
        statusText.className = `text-${statusColors[status] || 'secondary'}`;
    }
}

// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化字元計數
    updateCharCount('title', 'titleCount', 200);
    updateCharCount('content', 'contentCount', 5000);
    
    // 初始化預覽
    updatePreview();
    
    // 綁定事件
    document.getElementById('title').addEventListener('input', function() {
        updateCharCount('title', 'titleCount', 200);
        updatePreview();
    });
    
    document.getElementById('content').addEventListener('input', function() {
        updateCharCount('content', 'contentCount', 5000);
        updatePreview();
    });
    
    document.getElementById('date').addEventListener('change', updatePreview);
    document.getElementById('link').addEventListener('input', updatePreview);
    document.getElementById('status').addEventListener('change', updatePreview);
    
    // 表單驗證
    document.getElementById('newsForm').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const date = document.getElementById('date').value;
        
        if (!title) {
            e.preventDefault();
            alert('請輸入標題');
            document.getElementById('title').focus();
            return false;
        }
        
        if (!date) {
            e.preventDefault();
            alert('請選擇日期');
            document.getElementById('date').focus();
            return false;
        }
        
        // 字元長度檢查
        if (title.length > 200) {
            e.preventDefault();
            alert('標題不能超過200字元');
            document.getElementById('title').focus();
            return false;
        }
        
        const content = document.getElementById('content').value;
        if (content.length > 5000) {
            e.preventDefault();
            alert('內容不能超過5000字元');
            document.getElementById('content').focus();
            return false;
        }
    });
});

// 自動填入今天日期（如果沒有選擇日期）
document.getElementById('date').addEventListener('focus', function() {
    if (!this.value) {
        const today = new Date().toISOString().split('T')[0];
        this.value = today;
        updatePreview();
    }
});
</script>
{% endblock %}
